<script type="text/javascript">
$('#navTab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
})
</script>

<div class="container" ng-init="tabShow = 'home'">

	<div class="row">
		<ul class="nav nav-tabs" id="navTab">
			<li ng-class="{active: tabShow == 'home'}"><a ng-click="tabShow = 'home'">Home</a></li>
			<li ng-class="{active: tabShow == 'users'}"><a ng-click="tabShow = 'users'">Users</a></li>
			<li ng-class="{active: tabShow == 'apps'}"><a ng-click="tabShow = 'apps'">Apps</a></li>
			<li ng-class="{active: tabShow == 'providers'}"><a ng-click="tabShow = 'providers'">Providers</a></li>
			<li ng-class="{active: tabShow == 'stats'}"><a ng-click="tabShow = 'stats'">Stats</a></li>
			<li ng-class="{active: tabShow == 'scopes'}"><a ng-click="tabShow = 'scopes'">Scopes</a></li>
			<li ng-class="{active: tabShow == 'rankings'}"><a ng-click="tabShow = 'rankings'">Rankings</a></li>
			<li ng-class="{active: tabShow == 'wishlist'}"><a ng-click="tabShow = 'wishlist'">Wishlist</a></li>
		</ul>
	</div>

	<div class="tab-content" style="padding-top:20px;">

		<!-- home -->
		<div ng-show="tabShow == 'home'">
			<div class="col-lg-4">
				<h3>Force updates:</h3>
				<form ng-submit="mailjetUpdate()">
					<button class="col" type="submit">Force mailjet contacts update</button>
				</form>
				<form ng-submit="rankingsUpdate()">
					<button class="col" type="submit">Force rankings update</button>
				</form>
				<form ng-submit="resetSecrets()">
					<button class="col" type="submit">Reset all secret keys</button>
				</form>
				<form ng-submit="cohortAnalysis()" class="form-inline" role="form">
					<div class="form-group">
						<label class="sr-only" for="cohortStart">Start date</label>
						<input type="text" class="form-control" id="cohortStart" placeholder="Start date">
					</div>
					<div class="form-group">
						<label class="sr-only" for="cohortEnd">End date</label>
						<input type="text" class="form-control" id="cohortEnd" placeholder="End date">
					</div>
					<button type="submit" class="btn btn-default">Cohort Analysis (what does "cohort" means?)</button>
				</form>
			</div>
			<div class="col-lg-12" id="cohort-row" ng-show="cohort">
				<div class="row">
					<div class="col-lg-2"><div class="well well-sm">Subscribe<br/>{{cohort.sum[0]}}</div></div>
					<div class="col-lg-2"><span class="glyphicon glyphicon-circle-arrow-right"></span><br/>{{cohort.conversion[0]}} %<br/>{{cohort.lag[0]}}</div>
					<div class="col-lg-2"><div class="well well-sm">Registration<br/>{{cohort.sum[1]}}</div></div>
					<div class="col-lg-2"><span class="glyphicon glyphicon-circle-arrow-right"></span><br/>{{cohort.conversion[1]}} %<br/>{{cohort.lag[1]}}</div>
					<div class="col-lg-2"><div class="well well-sm">Activation<br/>{{cohort.sum[2]}}</div></div>
					<div class="col-lg-2"><span class="glyphicon glyphicon-circle-arrow-right"></span><br/>{{cohort.conversion[2]}} %<br/>{{cohort.lag[2]}}</div>
				</div>
				<div class="row">
					<div class="col-lg-2"><div class="well well-sm">Development<br/>{{cohort.sum[3]}}</div></div>
					<div class="col-lg-2"><span class="glyphicon glyphicon-circle-arrow-right"></span><br/>{{cohort.conversion[3]}} %<br/>{{cohort.lag[3]}}</div>
					<div class="col-lg-2"><div class="well well-sm">Production<br/>{{cohort.sum[4]}}</div></div>
					<div class="col-lg-2"><span class="glyphicon glyphicon-circle-arrow-right"></span><br/>{{cohort.conversion[4]}} %<br/>{{cohort.lag[4]}}</div>
					<div class="col-lg-2"><div class="well well-sm">Consumer<br/>{{cohort.sum[5]}}</div></div>
				</div>
			</div>
		</div>

		<!-- users -->
		<div ng-show="tabShow == 'users'">
			<div class="col-lg-12">
				<div class="row">
					<div class="input-group col-lg-12">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="query.email" ng-change="queryChange()" >
					</div>
					<div class="col-lg-12">
						<div class="alert alert-error" ng-show="info.status == 'error'">{{info.message}}</div>
					</div>
				</div>

				<div class="row" style="margin-top: 10px;">
					<table class="table table-striped">
						<tr>
							<th>#</th>
							<th>Email</th>
							<th>Created at</th>
							<th colspan="3" style="text-align:center;">Action</th>
						</tr>
						<tr ng-repeat="user in filtered |Â startFrom:(pagination.current-1)* pagination.nbPerPage | limitTo:pagination.nbPerPage" ng-model="users">
							<td>{{user.id}}</td>
							<td>{{user.email}}</td>
							<td style="min-width:250px;width:250px;">{{user.date_inscr|date:'MMMM d, yyyy'}}</td>
							<td>
								<button ng-show="user.validated == '0'" class="btn btn-small btn-success" ng-click="sendRequest(user)">Invite</button>
								<button ng-show="user.validated == '2'" class="btn btn-small btn-warning" ng-click="sendRequest(user)">Reinvite</button>
							</td>
							<td>
								<a href="#myModal" role="button" class="btn btn-small btn-primary" data-toggle="modal" ng-click="getUserDetails(user)">Details</a>
							</td>
							<td>
								<button ng-click="removeUser(user)" class="btn btn-danger btn-small">remove</button>
							</td>
						</tr>
					</table>

					<div class="row">
						<pagination style="margin-top: -5px; cursor: pointer;" num-pages="pagination.nbPages" current-page="pagination.current" max-size="pagination.max"></pagination>
					</div>
					<button ng-hide="nbUnvalidatedUser == 0" ng-click="inviteAllUsers()" class="btn btn-success">Invite 20 next users</button><span style="position: relative; left: 20px">unvalidated: {{nbUnvalidatedUser}}</span><hr />
				</div>
			</div>
		</div>

		<!-- stats -->
		<div ng-show="tabShow == 'stats'">

			<div class="col-lg-12">
				<form ng-submit="chartSubmit()">
					<div class="row">
						<input class="col" type="text" ng-model="chart.stat" value="users"/>
						<select class="col" ng-model="chart.stat" ng-change="chartSubmit()">
							<option value="users">users</option>
							<option value="u:validate">users validate</option>
							<option value="u:login">users sign in</option>
							<option value="apps">apps</option>
							<option value="keysets">keysets</option>
							<option value="co">connections</option>
							<option value="co:uid">connections (unique users)</option>
							<option value="req">requests</option>
							<option value="co:success">connections success</option>
							<option value="co:uid:success">connections success (unique users)</option>
							<option value="co:error">connections fails</option>
							<option value="co:uid:error">connections fails (unique users)</option>
							<option value="co:p:facebook">facebook connections</option>
							<option value="co:uid:p:facebook">facebook connections (unique users)</option>
							<option value="co:p:facebook:success">facebook connections success</option>
							<option value="co:uid:p:facebook:success">facebook connections success (unique users)</option>
							<option value="co:p:facebook:error">facebook connections fails</option>
							<option value="co:uid:p:facebook:error">facebook connections fails (unique users)</option>
							<option value="req:p:twitter">twitter api requests</option>
							<option value="p:facebook:keysets">facebook keysets</option>
							<option value="co:a:AN APP KEY">an app connections</option>
							<option value="co:uid:a:AN APP KEY">an app connections (unique users)</option>
							<option value="co:a:AN APP KEY:success">an app connections success</option>
							<option value="co:uid:a:AN APP KEY:success">an app connections success (unique users)</option>
							<option value="co:a:AN APP KEY:error">an app connections fails</option>
							<option value="co:uid:a:AN APP KEY:error">an app connections fails (unique users)</option>
							<option value="a:AN APP KEY:keysets">an app keysets</option>
							<option value="req:a:AN APP KEY">an app requests</option>
							<option value="co:a:AN APP KEY:p:facebook">an app facebook connections</option>
							<option value="co:uid:a:AN APP KEY:p:facebook">an app facebook connections (unique users)</option>
							<option value="co:a:AN APP KEY:p:facebook:success">an app facebook connections success</option>
							<option value="co:uid:a:AN APP KEY:p:facebook:success">an app facebook connections success (unique users)</option>
							<option value="co:a:AN APP KEY:p:facebook:error">an app facbeook connections fails</option>
							<option value="co:uid:a:AN APP KEY:p:facebook:error">an app facbeook connections fails (unique users)</option>
							<option value="req:a:AN APP KEY:p:twitter">an app twitter requests</option>
						</select>
						<select ng-model="chart.day" ng-change="chartSubmit()">
							<option value="1">1 day</option>
							<option value="3">3 days</option>
							<option value="15">15 days</option>
							<option value="31">1 month</option>
							<option value="92">3 month</option>
							<option value="183">6 month</option>
						</select>
						<div class="form-group">
							<label class="sr-only" for="cohortStart">Start date</label>
							<input type="text" class="form-control" id="statsStart" placeholder="Start date" ng-model="chart.start" ng-change="chartSubmit()">
						</div>
						<div class="form-group">
							<label class="sr-only" for="cohortEnd">End date</label>
							<input type="text" class="form-control" id="statsEnd" placeholder="End date" ng-model="chart.end" ng-change="chartSubmit()">
						</div>
						<button class="col" type="submit">Search</button>
					</div>
				</form>
				<h4><strong>Total:</strong> {{chart.total}} - <strong>Selection total:</strong> {{chart.selTotal}}</h4>
				<div class="row" style="margin-top: 10px;">
					<canvas id="chartCanevas" width="1000" height="400"></canvas>
				</div>
			</div>
		</div>

		<!-- wishlist -->
		<div ng-show="tabShow == 'wishlist'">

			<div class="col-lg-12">
				<div class="alert alert-error" ng-show="info.status">{{info.message}}</div>
			</div>
			<div class="col-lg-12">

				<div class="row">
					<div class="input-group col-lg-12">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="query.name" ng-change="wishListQueryChange(query)" >
					</div>
				</div>

				<table class="table table-striped">
					<tr>
						<th>Name</th>
						<th>Status</th>
						<th>Count</th>
						<th colspan="5">Actions</th>
					</tr>
					<tr ng-repeat="provider in wishListFiltered | orderBy:['-count','+name'] | startFrom:(wishListPagination.current-1)*wishListPagination.nbPerPage | limitTo:wishListPagination.nbPerPage" ng-model="providers">
						<td><img style="margin-right: 10px" class="pull-left" width="24" height="24" ng-src="/api/providers/{{provider.name}}/logo">{{provider.name|capitalize}}</td>
						<td>{{provider.status}}</td>
						<td>{{provider.count}}</td>
						<td>
							<button ng-show="provider.status != 'asked'" class="btn btn-small btn-success" ng-click="setProviderStatus(provider, 'asked')">Asked</button>
						</td>
						<td>
							<button ng-show="provider.status != 'spam'" class="btn btn-danger btn-small" ng-click="setProviderStatus(provider, 'spam')">Spam</button>
						</td>
						<td>
							<button ng-show="provider.status != 'non-oauth'" class="btn btn-danger btn-small" ng-click="setProviderStatus(provider, 'non-oauth')">Non-oauth</button>
						</td>
						<td>
							<button ng-show="provider.status != 'dev'" class="btn btn-small btn-warning" ng-click="setProviderStatus(provider, 'dev')">Dev</button>
						</td>
						<td>
							<button ng-show="provider.status != 'release'" class="btn btn-small btn-primary" ng-click="setProviderStatus(provider, 'release')">Release</button>
						</td>
						<td>
							<button ng-click="removeProvider(provider)" class="btn btn-danger btn-small">remove</button>
						</td>
					</tr>
				</table>

				<div class="row">
					<pagination style="margin-top: -5px; cursor: pointer;" num-pages="wishListPagination.nbPages" current-page="wishListPagination.current" max-size="wishListPagination.max"></pagination>
				</div>
			</div>
		</div>

		<!-- rankings -->
		<div ng-show="tabShow == 'rankings'">
			<div class="col-lg-12">
				<div class="alert alert-error" ng-show="info.status">{{info.message}}</div>
			</div>
			<div class="col-lg-12">
				<div class="navbar">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a class="dropdown-toggle" data-toggle="dropdown">
								Selection<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								<li><a ng-click='setRankingTarget("a:k")'>Apps -> keys</a></li>
								<li><a ng-click='setRankingTarget("a:co")'>Apps -> auth</a></li>
								<li><a ng-click='setRankingTarget("a:co:uid")'>Apps -> auth (unique)</a></li>
								<li><a ng-click='setRankingTarget("a:co:success")'>Apps -> auth success</a></li>
								<li><a ng-click='setRankingTarget("a:co:uid:success")'>Apps -> auth success (unique)</a></li>
								<li><a ng-click='setRankingTarget("a:co:error")'>Apps -> auth errors</a></li>
								<li><a ng-click='setRankingTarget("a:co:uid:error")'>Apps -> auth errors (unique)</a></li>
								<li><a ng-click='setRankingTarget("a:req")'>Apps -> requests</a></li>
								<li class="divider"></li>
								<li><a ng-click='setRankingTarget("p:k")'>Providers -> keys</a></li>
								<li><a ng-click='setRankingTarget("p:co")'>Providers -> auth</a></li>
								<li><a ng-click='setRankingTarget("p:co:uid")'>Providers -> auth (unique)</a></li>
								<li><a ng-click='setRankingTarget("p:co:success")'>Providers -> auth success</a></li>
								<li><a ng-click='setRankingTarget("p:co:uid:success")'>Providers -> auth success (unique)</a></li>
								<li><a ng-click='setRankingTarget("p:co:error")'>Providers -> auth errors</a></li>
								<li><a ng-click='setRankingTarget("p:co:uid:error")'>Providers -> auth errors (unique)</a></li>
								<li><a ng-click='setRankingTarget("p:req")'>Providers -> requests</a></li>
							</ul>
						</li>
						<li>
							<ul class="nav nav-tabs">
								<li><a data-toggle="tab" ng-click='setRankingUnit("d")'>Day</a></li>
								<li><a data-toggle="tab" ng-click='setRankingUnit("w")'>Week</a></li>
								<li><a data-toggle="tab" ng-click='setRankingUnit("m")'>Month</a></li>
								<li class="active"><a data-toggle="tab" ng-click='setRankingUnit("")'>All</a></li>
							</ul>
						</li>
					</ul>

				</div>

				<div class="col-lg-8"><h3>{{ranking.target_names[ranking.target]}} ({{ranking.unit_names[ranking.unit]}})</h3></div>

				<table class="table table-striped">
					<tr>
						<th>Infos</th>
						<th>Count</th>
					</tr>
						<tr ng-repeat="rank in ranksFiltered | orderBy:['-score','+name'] | startFrom:(ranksPagination.current-1)*ranksPagination.nbPerPage | limitTo:ranksPagination.nbPerPage">
						<td>
							<ng-switch on="ranking.type">
								<span ng-switch-when="provider">
									<img style="margin-right: 10px" class="pull-left" width="24" height="24" ng-src="/api/providers/{{rank.name}}/logo">{{rank.name|capitalize}}
								</span>
								<span ng-switch-default>
									{{rank.name|capitalize}}
								</span>
							</ng-switch>
						</td>
						<td>{{rank.score}}</td>
					</tr>
				</table>

				<div class="row">
					<pagination style="margin-top: -5px; cursor: pointer;" num-pages="ranksPagination.nbPages" current-page="ranksPagination.current" max-size="ranksPagination.max"></pagination>
				</div>

			</div>
		</div>


		<!-- providers -->
		<div ng-show="tabShow == 'providers'">
			<div class="col-lg-12">
				<div class="alert alert-error" ng-show="info.status">{{info.message}}</div>
			</div>
			<div class="col-lg-12">
				<div class="row">
					<div class="col-lg-1">Provider</div>
					<div class="input-group col-lg-11">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="providerQuery.name" ng-change="providerQueryChange()" typeahead="provider for provider in providers | filter:providerQuery.name" >
					</div>
				</div>
				<div class="navbar">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a class="dropdown-toggle" data-toggle="dropdown">
								Selection<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								<li><a ng-click='setProviderRankingTarget("p:auth_array:[provider]")'>Scopes auth</a></li>
								<li><a ng-click='setProviderRankingTarget("p:auth_array:[provider]:success")'>Scopes auth success</a></li>
								<li><a ng-click='setProviderRankingTarget("p:auth_array:[provider]:error")'>Scopes auth errors</a></li>
							</ul>
						</li>
						<li>
							<ul class="nav nav-tabs">
								<li><a data-toggle="tab" ng-click='setProviderRankingUnit("d")'>Day</a></li>
								<li><a data-toggle="tab" ng-click='setProviderRankingUnit("w")'>Week</a></li>
								<li><a data-toggle="tab" ng-click='setProviderRankingUnit("m")'>Month</a></li>
								<li class="active"><a data-toggle="tab" ng-click='setProviderRankingUnit("")'>All</a></li>
							</ul>
						</li>
					</ul>

				</div>

				<div class="col-lg-8"><h3>
					<span>
						<img style="margin-right: 10px" class="pull-left" width="24" height="24" ng-src="/api/providers/{{provider_ranking.name}}/logo">{{provider_ranking.name|capitalize}}
					</span> - {{provider_ranking.target_names[provider_ranking.target]}} ({{ranking.unit_names[provider_ranking.unit]}})
				</h3></div>

				<table class="table table-striped">
					<tr>
						<th>Infos</th>
						<th>Count</th>
					</tr>
						<tr ng-repeat="rank in providerFiltered | orderBy:['-score','+name'] | startFrom:(providerPagination.current-1)*providerPagination.nbPerPage | limitTo:providerPagination.nbPerPage">
						<td>{{rank.name}}</td>
						<td>{{rank.score}}</td>
					</tr>
				</table>

				<div class="row">
					<pagination style="margin-top: -5px; cursor: pointer;" num-pages="providerPagination.nbPages" current-page="providerPagination.current" max-size="providerPagination.max"></pagination>
				</div>

			</div>
		</div>


		<!-- scopes -->
		<div ng-show="tabShow == 'scopes'">
			<div class="col-lg-12">
				<div class="alert alert-error" ng-show="info.status">{{info.message}}</div>
			</div>
			<div class="col-lg-12">
				<div class="row">
					<div class="col-lg-1">Scopes</div>
					<div class="input-group col-lg-11">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="scopeQuery.name" ng-change="scopeQueryChange()" value="*">
					</div>
				</div>

				<table class="table table-striped">
					<tr>
						<th>Scope</th>
						<th>% User failures</th>
						<th>Count</th>
					</tr>
					<tr ng-repeat="scope in scopeFiltered | orderBy:['-score','+name'] | startFrom:(scopePagination.current-1)*scopePagination.nbPerPage | limitTo:scopePagination.nbPerPage">
						<td>{{scope.name}}</td>
						<td>{{scope.score / 100}} %</td>
						<td>{{scope.count}}</td>
					</tr>
				</table>

				<div class="row">
					<pagination style="margin-top: -5px; cursor: pointer;" num-pages="scopePagination.nbPages" current-page="scopePagination.current" max-size="scopePagination.max"></pagination>
				</div>

			</div>
		</div>


		<!-- apps -->
		<div ng-show="tabShow == 'apps'">
			<div class="col-lg-12">
				<div class="alert alert-error" ng-show="info.status">{{info.message}}</div>
			</div>
			<div class="col-lg-12">
				<div class="row">
					<div class="col-lg-1">App's key</div>
					<div class="input-group col-lg-11">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="appQuery.key" ng-change="appQueryChange()">
					</div>
				</div>
				<div class="row">
					<div class="col-lg-1">Provider</div>
					<div class="input-group col-lg-11">
						<span class="input-group-addon">
							<i class="glyphicon glyphicon-search"></i>
						</span>
						<input type="text" ng-model="providerAppQuery.name" ng-change="providerAppQueryChange()" typeahead="provider for provider in providers | filter:providerAppQuery.name" >
					</div>
				</div>
				<div class="navbar">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a class="dropdown-toggle" data-toggle="dropdown">
								Selection<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								<li><a ng-click='setAppRankingTarget("a:auth_array:[app]:p:[provider]")'>Scopes auth</a></li>
								<li><a ng-click='setAppRankingTarget("a:auth_array:[app]:p:[provider]:success")'>Scopes auth success</a></li>
								<li><a ng-click='setAppRankingTarget("a:auth_array:[app]:p:[provider]:error")'>Scopes auth errors</a></li>
							</ul>
						</li>
						<li>
							<ul class="nav nav-tabs">
								<li><a data-toggle="tab" ng-click='setAppRankingUnit("d")'>Day</a></li>
								<li><a data-toggle="tab" ng-click='setAppRankingUnit("w")'>Week</a></li>
								<li><a data-toggle="tab" ng-click='setAppRankingUnit("m")'>Month</a></li>
								<li class="active"><a data-toggle="tab" ng-click='setAppRankingUnit("")'>All</a></li>
							</ul>
						</li>
					</ul>

				</div>

				<div class="col-lg-8"><h3>
					<span>
						<img style="margin-right: 10px" class="pull-left" width="24" height="24" ng-src="/api/providers/{{app_ranking.name}}/logo">{{app_ranking.name|capitalize}}
					</span> - {{app_ranking.target_names[app_ranking.target]}} ({{ranking.unit_names[app_ranking.unit]}})
				</h3></div>

				<table class="table table-striped">
					<tr>
						<th>Infos</th>
						<th>Count</th>
					</tr>
						<tr ng-repeat="rank in appFiltered | orderBy:['-score','+name'] | startFrom:(appPagination.current-1)*appPagination.nbPerPage | limitTo:appPagination.nbPerPage">
						<td>{{rank.name}}</td>
						<td>{{rank.score}}</td>
					</tr>
				</table>

				<div class="row">
					<pagination style="margin-top: -5px; cursor: pointer;" num-pages="appPagination.nbPages" current-page="appPagination.current" max-size="appPagination.max"></pagination>
				</div>

			</div>
		</div>

	</div>
</div>


<div class="modal fade" id="myModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Details about {{user.email}}</h4>
			</div>
			<pre>{{user|json}}</pre>
			<div class="accordion" id="accordion2">
				<div class="accordion-group" ng-repeat="app in user.apps">
					<div class="accordion-heading">
						<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse_{{app.id}}">{{app.name}} <small>( {{app.domains.length}} domain(s), {{app.providers.length}} provider(s))</small></a>
					</div>
					<div id="collapse_{{app.id}}" class="accordion-body collapse out">
						<div class="accordion-inner">
							<div class="row" style="word-wrap: break-word;">
								<label>Domains:</label>&nbsp;<span ng-repeat="domain in app.domains">{{domain}}&nbsp;</span>
							</div>

							<div class="row" style="word-wrap: break-word;">
								<label>Providers:&nbsp;</label>&nbsp;<span ng-repeat="provider in app.providers">{{provider}}&nbsp;</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dalog -->
</div><!-- /.modal -->